---
---

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Remote Sensing & Classification</title>
<meta name="description" content="">
<link rel="canonical"
  href="http://cyberhelp.sesync.org/remote-sensing-classification-lesson/course/archive.html">
<link href="https://cdn.jsdelivr.net/gh/sesync-ci/lesson-style@v2.0/docs/css/default.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/gh/sesync-ci/lesson-style@v2.0/docs/css/syntax.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/gh/sesync-ci/lesson-style@v2.0/docs/css/static.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>

    

  </head>
  <body>
    <div class="page-content">
      <div class="wrapper">
        
        
<h1 style="text-transform: none;" id="remote-sensing--classification">Remote Sensing &amp; Classification</h1>

<h2 style="text-transform: none;" id="hurricane-inundation">Hurricane Inundation</h2>

<p>Lesson 5 with <em>Rachael Blake</em></p>

<nav id="ToC">

  <ul>
    <li><a href="#/slides/intro">Introduction to Raster Classification</a></li>
    <li><a href="#/slides/raster_classification">Raster Classification using flood mapping analysis</a></li>
  </ul>
</nav>

<hr />
<p><a name="/slides/intro"></a></p>

<p>Remote Sensing allows for fast generation of maps before and after events. In this exercise, you will map flooding using machine learning methods and MODIS reflectance data (MOD09). Hurricanes can strongly impact vegetation and human settlements. Hurricane Rita made landfall on September 24, 2005 in Louisiana near the border with Texas. In addition to the rainfall, the hurricane was accompanied by a storm surge that generated flooding and a large amount of damage to ground infrastructure and vegetation. As a geospatial analyst, you will experiment with different classifiers for rapid mapping and examine their performance with training and testing data. All work must be repeatable and documented in a scripting environment to be shared with your team.</p>

<h2 id="inputs">Inputs</h2>

<ul>
  <li>FEMA flood map (stored as vector data)</li>
  <li>MOD09 reflectance image after Hurricane Rita</li>
  <li>Vector polygons of ground truth (for training and testing classifiers)</li>
  <li>NLCD 2006 land cover aggregated at 1km</li>
</ul>

<h2 id="outputs">Outputs</h2>

<ul>
  <li>classified map using rpart classifier</li>
  <li>classified map using svm classifier</li>
  <li>confusion matrices and overall accuracies by classifiers</li>
</ul>

<h2 id="toolsfunctions">Tools/Functions</h2>

<ul>
  <li>raster::brick</li>
  <li>raster::writeRaster</li>
  <li>sf::st_read</li>
  <li>raster::subset</li>
  <li>raster::extract</li>
  <li>raster::predict</li>
  <li>raster algebra: “*”,” /”,”+”,”-“</li>
  <li>rasterVis::levelplot</li>
  <li>rasterVis::histogram</li>
</ul>

<h2 id="part-i-read-and-map-flooding-from-rita-hurricane">Part I: Read and map flooding from RITA hurricane</h2>

<p>Explore the datasets provided. Use ground truth vector datasets and extract values for pixels for the raster stack containing the original MOD09 bands and indices. Visualize ground truth pixels in feature space and using boxplots.</p>

<p>Products:</p>
<ul>
  <li>Scatterplot in feature space with the three ground classes.</li>
  <li>Boxplots of values for MNDWI indices.</li>
</ul>

<h2 id="part-ii-split-data-into-training-and-testing-datasets">Part II: Split data into training and testing datasets</h2>

<p>Assessment of classifications require splitting of the ground truth data into training and testing samples. The training data is used in the fitting of the model while the testing dataset is used accuracy assessment. Using the data provided randomly select 30% ground truth data for testing.</p>

<p>Products:</p>
<ul>
  <li>Training and testing datasets at 30%. Save these into shapefiles.</li>
</ul>

<p>Be able to answer the following question:</p>
<ul>
  <li>What is the frequency of observations in each class for training and testing data?</li>
</ul>

<h2 id="part-iii--generate-classification-using-classification-tree-cart-and-support-vector-machine-svm">Part III:  Generate classification using classification tree (CART) and support vector machine (SVM)</h2>

<p>You will use MOD09 reflectance bands to generate a classification of three classes (“vegetation”, “wetland”, “water”). Fit a model with the training data for each method and generate a classification on a raster using the “predict” command.</p>

<p>RPART: It is based on CART and generates classification by splitting data points into branches successively and generating classified pixels. The rules generated from the tree can then be applied to the full raster image to produce a prediction.</p>

<p>SVM: Support Vector Machine  generate hyperplanes that maximize separabiltiy between classes.These hyperplanes boundaries are used in the classification process and generate predictions.</p>

<p>Products:</p>
<ul>
  <li>Model object for rpart with a predicted raster.</li>
  <li>Model object for svm with a predicted raster</li>
</ul>

<h2 id="part-iv-assessment-and-comparison-of-model-performance">Part IV: Assessment and comparison of model performance</h2>

<p>To validate the model, we use the testing data and generate new predictions for rpart and SVM. We compare the predictions with the original testing information.</p>

<p>Overall accuracy: total number of correctly classified pixels for all classes combined over the total number of pixels.</p>

<p>Producer accuracy: is the fraction of correctly classified pixels with regard to all pixels of the ground truth class.</p>

<p>Products:</p>
<ul>
  <li>Overall accuracy and producer accuracy metrics.</li>
  <li>Confusion matrix for rpart and SVM.</li>
</ul>

<p>Be able to answer the following question:</p>
<ul>
  <li>What classifier had the best overall accuracy?</li>
</ul>

<p>Using the analyses performed above, and datasets provided answer to the following questions:</p>

<ul>
  <li>Modify the splitting of training and testing by using 40% and then 50% for testing. Compare predicted maps with previous results.</li>
  <li>Generate confusion matrices for 40% and 50% testing.</li>
  <li>Generate a classification prediction using randomForest and compare it to svm and rpart with 30% holdout.</li>
</ul>

<p class="ToS"><a href="#/slides/intro">Top of Section</a></p>

<hr />
<p><a name="/slides/raster_classification"></a></p>

<h3 id="set-up-arguments-and-parameters">Set up arguments and parameters</h3>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">in_dir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"data"</span><span class="w">

</span><span class="n">out_dir_suffix</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"rsc_lesson"</span><span class="w">
</span><span class="n">out_dir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="s2">"output_"</span><span class="p">,</span><span class="w"> </span><span class="n">out_dir_suffix</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span><span class="w">
</span><span class="n">dir.create</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span><span class="w"> </span><span class="n">showWarnings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Regional coordinate reference system taken from: 
http://spatialreference.org/ref/epsg/nad83-texas-state-mapping-system/proj4/</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">CRS_reg</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"+proj=lcc +lat_1=27.41666666666667 +lat_2=34.91666666666666 +lat_0=31.16666666666667 +lon_0=-100 +x_0=1000000 +y_0=1000000 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"</span><span class="w"> 

</span><span class="n">file_format</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">".tif"</span><span class="w"> 

</span><span class="n">NA_flag_val</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">-9999</span><span class="w">

</span><span class="n">out_suffix</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"raster_classification"</span><span class="w"> </span><span class="c1"># output suffix for the files and output folder  </span><span class="w">
</span></code></pre></div></div>

<h3 id="define-input-data-file-names">Define input data file names</h3>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">infile_RITA_reflectance_date2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"mosaiced_MOD09A1_A2005273__006_reflectance_masked_RITA_reg_1km.tif"</span><span class="w">

</span><span class="n">infile_reg_outline</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"new_strata_rita_10282017"</span><span class="w"> </span><span class="c1"># Region outline and FEMA zones</span><span class="w">

</span><span class="n">infile_modis_bands_information</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"df_modis_band_info.txt"</span><span class="w"> </span><span class="c1"># MOD09 bands information.</span><span class="w">

</span><span class="n">nlcd_2006_filename</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"nlcd_2006_RITA.tif"</span><span class="w"> </span><span class="c1"># NLCD2006 Land cover data aggregated at ~ 1km.</span><span class="w">
</span></code></pre></div></div>

<h2 id="part-i-read-and-map-flooding-from-rita-hurricane">Part I: Read and map flooding from RITA hurricane</h2>

<h3 id="display-and-explore-the-data">Display and explore the data</h3>

<p>MOD09 raster image after hurricane Rita.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">r_after</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">brick</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">in_dir</span><span class="p">,</span><span class="w"> </span><span class="n">infile_RITA_reflectance_date2</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">head</span><span class="p">(</span><span class="n">r_after</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      mosaiced_MOD09A1_A2005273__006_reflectance_masked_RITA_reg_1km.1
 [1,]                                                       0.04558113
 [2,]                                                       0.04460510
 [3,]                                                       0.04348749
 [4,]                                                       0.04507260
 [5,]                                                       0.04715690
 [6,]                                                       0.03485106
 [7,]                                                       0.03807684
 [8,]                                                       0.04214056
 [9,]                                                       0.04512509
[10,]                                                       0.04687950
[11,]                                                       0.04639116
[12,]                                                       0.04591873
[13,]                                                       0.04590000
[14,]                                                       0.05590000
[15,]                                                       0.05367381
[16,]                                                       0.05220000
[17,]                                                       0.05146399
[18,]                                                       0.04496353
[19,]                                                       0.04380151
[20,]                                                       0.06080000
      mosaiced_MOD09A1_A2005273__006_reflectance_masked_RITA_reg_1km.2
 [1,]                                                        0.3027903
 [2,]                                                        0.3043112
 [3,]                                                        0.2998908
 [4,]                                                        0.3017146
 [5,]                                                        0.3239896
 [6,]                                                        0.2683164
 [7,]                                                        0.2991171
 [8,]                                                        0.3176138
 [9,]                                                        0.3125040
[10,]                                                        0.2979249
[11,]                                                        0.3101786
[12,]                                                        0.3076983
[13,]                                                        0.3076000
[14,]                                                        0.2953000
[15,]                                                        0.3113045
[16,]                                                        0.3219000
[17,]                                                        0.3242094
[18,]                                                        0.3254988
[19,]                                                        0.3138167
[20,]                                                        0.3098000
      mosaiced_MOD09A1_A2005273__006_reflectance_masked_RITA_reg_1km.3
 [1,]                                                       0.02379627
 [2,]                                                       0.02354558
 [3,]                                                       0.02374887
 [4,]                                                       0.02426019
 [5,]                                                       0.02511090
 [6,]                                                       0.01941371
 [7,]                                                       0.02170737
 [8,]                                                       0.02348050
 [9,]                                                       0.02387191
[10,]                                                       0.02560453
[11,]                                                       0.02765067
[12,]                                                       0.02635150
[13,]                                                       0.02630000
[14,]                                                       0.03030000
[15,]                                                       0.02999916
[16,]                                                       0.02980000
[17,]                                                       0.02756310
[18,]                                                       0.02447605
[19,]                                                       0.02306678
[20,]                                                       0.03420000
      mosaiced_MOD09A1_A2005273__006_reflectance_masked_RITA_reg_1km.4
 [1,]                                                       0.05476730
 [2,]                                                       0.05586702
 [3,]                                                       0.05381133
 [4,]                                                       0.05503851
 [5,]                                                       0.05962222
 [6,]                                                       0.04450204
 [7,]                                                       0.04927124
 [8,]                                                       0.05364913
 [9,]                                                       0.05487191
[10,]                                                       0.05564768
[11,]                                                       0.05650510
[12,]                                                       0.05544214
[13,]                                                       0.05540000
[14,]                                                       0.05870000
[15,]                                                       0.06014401
[16,]                                                       0.06110000
[17,]                                                       0.06231735
[18,]                                                       0.05556127
[19,]                                                       0.05338556
[20,]                                                       0.06660000
      mosaiced_MOD09A1_A2005273__006_reflectance_masked_RITA_reg_1km.5
 [1,]                                                        0.3318335
 [2,]                                                        0.3138186
 [3,]                                                        0.3123330
 [4,]                                                        0.3193893
 [5,]                                                        0.3417773
 [6,]                                                        0.2855803
 [7,]                                                        0.3055280
 [8,]                                                        0.3266653
 [9,]                                                        0.3330796
[10,]                                                        0.3139284
[11,]                                                        0.3352741
[12,]                                                        0.3151959
[13,]                                                        0.3144000
[14,]                                                        0.3485000
[15,]                                                        0.3409190
[16,]                                                        0.3359000
[17,]                                                        0.3346323
[18,]                                                        0.3365578
[19,]                                                        0.3272987
[20,]                                                        0.3235000
      mosaiced_MOD09A1_A2005273__006_reflectance_masked_RITA_reg_1km.6
 [1,]                                                        0.1902746
 [2,]                                                        0.1842244
 [3,]                                                        0.1855501
 [4,]                                                        0.1913280
 [5,]                                                        0.1930779
 [6,]                                                        0.1609111
 [7,]                                                        0.1696934
 [8,]                                                        0.1781321
 [9,]                                                        0.1907084
[10,]                                                        0.1913635
[11,]                                                        0.1840112
[12,]                                                        0.1886174
[13,]                                                        0.1888000
[14,]                                                        0.2295000
[15,]                                                        0.2199936
[16,]                                                        0.2137000
[17,]                                                        0.2036836
[18,]                                                        0.1829669
[19,]                                                        0.1818172
[20,]                                                        0.2122000
      mosaiced_MOD09A1_A2005273__006_reflectance_masked_RITA_reg_1km.7
 [1,]                                                       0.07314926
 [2,]                                                       0.06792310
 [3,]                                                       0.07248760
 [4,]                                                       0.07654412
 [5,]                                                       0.07032830
 [6,]                                                       0.05962812
 [7,]                                                       0.06153552
 [8,]                                                       0.06410249
 [9,]                                                       0.07345820
[10,]                                                       0.07704768
[11,]                                                       0.06562383
[12,]                                                       0.07223780
[13,]                                                       0.07250001
[14,]                                                       0.10140000
[15,]                                                       0.09135209
[16,]                                                       0.08470000
[17,]                                                       0.07624704
[18,]                                                       0.06806806
[19,]                                                       0.06944025
[20,]                                                       0.09370000
</code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">inMemory</span><span class="p">(</span><span class="n">r_after</span><span class="p">)</span><span class="w"> </span><span class="c1"># check if raster in memory</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] FALSE
</code></pre></div></div>

<p>Read band information since it is more informative.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">df_modis_band_info</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.table</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">in_dir</span><span class="p">,</span><span class="w"> </span><span class="n">infile_modis_bands_information</span><span class="p">),</span><span class="w">
                                 </span><span class="n">sep</span><span class="o">=</span><span class="s2">","</span><span class="p">,</span><span class="w"> </span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">df_modis_band_info</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  band_name band_number start_wlength end_wlength
1       Red           3           620         670
2       NIR           4           841         876
3      Blue           1           459         479
4     Green           2           545         565
5     SWIR1           5          1230        1250
6     SWIR2           6          1628        1652
7     SWIR3           7          2105        2155
</code></pre></div></div>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="nf">names</span><span class="p">(</span><span class="n">r_after</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df_modis_band_info</span><span class="o">$</span><span class="n">band_name</span><span class="w">
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">r_after</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] "Red"   "NIR"   "Blue"  "Green" "SWIR1" "SWIR2" "SWIR3"
</code></pre></div></div>

<p>Define bands of interest: Use subset instead of $ if you want to wrap code into function</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">raft_gr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">r_after</span><span class="p">,</span><span class="w"> </span><span class="s2">"Green"</span><span class="p">)</span><span class="w"> 
</span><span class="n">raft_SWIR</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">r_after</span><span class="p">,</span><span class="w"> </span><span class="s2">"SWIR2"</span><span class="p">)</span><span class="w">
</span><span class="n">raft_NIR</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">r_after</span><span class="p">,</span><span class="w"> </span><span class="s2">"NIR"</span><span class="p">)</span><span class="w"> 
</span><span class="n">raft_rd</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">r_after</span><span class="p">,</span><span class="w"> </span><span class="s2">"Red"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Manipulate bands of interest</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">r_after_MNDWI</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">raft_gr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">raft_SWIR</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">raft_gr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">raft_SWIR</span><span class="p">)</span><span class="w">

</span><span class="n">plot</span><span class="p">(</span><span class="n">r_after_MNDWI</span><span class="p">,</span><span class="w"> </span><span class="n">zlim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1</span><span class="p">,</span><span class="m">1</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>
<p class="captioned"><img src="https://cdn.jsdelivr.net/gh/sesync-ci/remote-sensing-classification-lesson@v0.1/docs/images/raster_classification/unnamed-chunk-12-1.png" alt=" " /></p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">r_after_NDVI</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">raft_NIR</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">raft_rd</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">raft_NIR</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">raft_rd</span><span class="p">)</span><span class="w">

</span><span class="n">plot</span><span class="p">(</span><span class="n">r_after_NDVI</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p class="captioned"><img src="https://cdn.jsdelivr.net/gh/sesync-ci/remote-sensing-classification-lesson@v0.1/docs/images/raster_classification/unnamed-chunk-13-1.png" alt=" " /></p>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">inMemory</span><span class="p">(</span><span class="n">r_after_MNDWI</span><span class="p">)</span><span class="w"> </span><span class="c1"># check if raster in memory</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] TRUE
</code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">inMemory</span><span class="p">(</span><span class="n">r_after_NDVI</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] TRUE
</code></pre></div></div>

<p>Write out rasters</p>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">dataType</span><span class="p">(</span><span class="n">r_after_NDVI</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] "FLT4S"
</code></pre></div></div>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">data_type_str</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dataType</span><span class="p">(</span><span class="n">r_after_NDVI</span><span class="p">)</span><span class="w">

</span><span class="n">NAvalue</span><span class="p">(</span><span class="n">r_after_MNDWI</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">NA_flag_val</span><span class="w"> </span><span class="c1"># set NA value</span><span class="w">
</span><span class="n">out_filename_mn</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">file.path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"mndwi_post_Rita"</span><span class="p">,</span><span class="s2">"_"</span><span class="p">,</span><span class="w"> </span><span class="n">out_suffix</span><span class="p">,</span><span class="w"> </span><span class="n">file_format</span><span class="p">))</span><span class="w">
</span><span class="n">writeRaster</span><span class="p">(</span><span class="n">r_after_MNDWI</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out_filename_mn</span><span class="p">,</span><span class="w"> </span><span class="n">datatype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_type_str</span><span class="p">,</span><span class="w">
            </span><span class="n">overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">
 
</span><span class="n">NAvalue</span><span class="p">(</span><span class="n">r_after_NDVI</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">NA_flag_val</span><span class="w">
</span><span class="n">out_filename_nd</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">file.path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"ndvi_post_Rita"</span><span class="p">,</span><span class="s2">"_"</span><span class="p">,</span><span class="w"> </span><span class="n">out_suffix</span><span class="p">,</span><span class="w"> </span><span class="n">file_format</span><span class="p">))</span><span class="w">
</span><span class="n">writeRaster</span><span class="p">(</span><span class="n">r_after_NDVI</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out_filename_nd</span><span class="p">,</span><span class="w"> </span><span class="n">datatype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_type_str</span><span class="p">,</span><span class="w">
            </span><span class="n">overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Remove rasters from memory</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">rm</span><span class="p">(</span><span class="n">r_after_MNDWI</span><span class="p">)</span><span class="w">
</span><span class="n">rm</span><span class="p">(</span><span class="n">r_after_NDVI</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Can view the .tif images written out in photo viewer.</p>

<p>Read in rasters</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">r_after_MNDWI</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">raster</span><span class="p">(</span><span class="n">out_filename_mn</span><span class="p">)</span><span class="w">
</span><span class="n">r_after_NDVI</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">raster</span><span class="p">(</span><span class="n">out_filename_nd</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">inMemory</span><span class="p">(</span><span class="n">r_after_MNDWI</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">inMemory</span><span class="p">(</span><span class="n">r_after_NDVI</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] FALSE
</code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] FALSE
</code></pre></div></div>

<h3 id="groundtruthing-data">Groundtruthing data</h3>
<p>Three levels of flooding (water content) determined via external grountruthing. 
Class 1: vegetation and other (small water fraction)
Class 2: Flooded vegetation
Class 3: Flooded area, or water (lake etc)</p>

<p>Read in a polygon for each class:</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">class1_data_sf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_read</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">in_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"class1_sites"</span><span class="p">))</span><span class="w"> 
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Reading layer `class1_sites' from data source `/nfs/public-data/training/class1_sites' using driver `ESRI Shapefile'
Simple feature collection with 6 features and 2 fields
geometry type:  POLYGON
dimension:      XY
bbox:           xmin: 1588619 ymin: 859495.9 xmax: 1830803 ymax: 941484.1
epsg (SRID):    NA
proj4string:    NA
</code></pre></div></div>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">class2_data_sf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_read</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">in_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"class2_sites"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Reading layer `class2_sites' from data source `/nfs/public-data/training/class2_sites' using driver `ESRI Shapefile'
Simple feature collection with 8 features and 2 fields
geometry type:  MULTIPOLYGON
dimension:      XY
bbox:           xmin: 1605433 ymin: 848843.8 xmax: 1794265 ymax: 884027.8
epsg (SRID):    NA
proj4string:    NA
</code></pre></div></div>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">class3_data_sf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_read</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">in_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"class3_sites"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Reading layer `class3_sites' from data source `/nfs/public-data/training/class3_sites' using driver `ESRI Shapefile'
Simple feature collection with 9 features and 2 fields
geometry type:  POLYGON
dimension:      XY
bbox:           xmin: 1587649 ymin: 845271.3 xmax: 1777404 ymax: 891073.1
epsg (SRID):    NA
proj4string:    NA
</code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">class1_data_sf</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Simple feature collection with 6 features and 2 fields
geometry type:  POLYGON
dimension:      XY
bbox:           xmin: 1588619 ymin: 859495.9 xmax: 1830803 ymax: 941484.1
epsg (SRID):    NA
proj4string:    NA
  record_ID class_ID                       geometry
1         1        1 POLYGON ((1610283 929863.7,...
2         2        1 POLYGON ((1755141 900167.2,...
3         3        1 POLYGON ((1688209 924699.1,...
4         4        1 POLYGON ((1821103 866597.2,...
5         5        1 POLYGON ((1806876 941161.3,...
6         6        1 POLYGON ((1588619 899198.8,...
</code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">plot</span><span class="p">(</span><span class="n">r_after_MNDWI</span><span class="p">,</span><span class="w"> </span><span class="n">zlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">-1</span><span class="p">,</span><span class="m">1</span><span class="p">))</span><span class="w"> 
</span><span class="o">&gt;</span><span class="w"> </span><span class="n">plot</span><span class="p">(</span><span class="n">class3_data_sf</span><span class="p">[</span><span class="s2">"class_ID"</span><span class="p">],</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">border</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"blue"</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p class="captioned"><img src="https://cdn.jsdelivr.net/gh/sesync-ci/remote-sensing-classification-lesson@v0.1/docs/images/raster_classification/unnamed-chunk-21-1.png" alt=" " /></p>

<p>Combine polygons; note they should be in the same projection system.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">class_data_sf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">class1_data_sf</span><span class="p">,</span><span class="w"> </span><span class="n">class2_data_sf</span><span class="p">,</span><span class="w"> </span><span class="n">class3_data_sf</span><span class="p">)</span><span class="w">

</span><span class="n">class_data_sf</span><span class="o">$</span><span class="n">poly_ID</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">class_data_sf</span><span class="p">)</span><span class="w"> </span><span class="c1"># unique ID for each polygon</span><span class="w">
</span></code></pre></div></div>

<p>23 different polygons used as ground truth data.</p>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">class_data_sf</span><span class="p">)</span><span class="w"> 
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 23
</code></pre></div></div>

<p>Make new rasters and raster stack.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">r_x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="n">r_after</span><span class="p">,</span><span class="w"> </span><span class="s2">"x"</span><span class="p">)</span><span class="w"> </span><span class="c1"># initializes a raster with coordinates x</span><span class="w">
</span><span class="n">r_y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="n">r_after</span><span class="p">,</span><span class="w"> </span><span class="s2">"y"</span><span class="p">)</span><span class="w"> </span><span class="c1"># initializes a raster with coordiates y</span><span class="w">

</span><span class="n">r_stack</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">stack</span><span class="p">(</span><span class="n">r_x</span><span class="p">,</span><span class="w"> </span><span class="n">r_y</span><span class="p">,</span><span class="w"> </span><span class="n">r_after</span><span class="p">,</span><span class="w"> </span><span class="n">r_after_NDVI</span><span class="p">,</span><span class="w"> </span><span class="n">r_after_MNDWI</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">r_stack</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"x"</span><span class="p">,</span><span class="w"> </span><span class="s2">"y"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Red"</span><span class="p">,</span><span class="w"> </span><span class="s2">"NIR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Blue"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Green"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SWIR1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SWIR2"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SWIR3"</span><span class="p">,</span><span class="w"> </span><span class="s2">"NDVI"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MNDWI"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">str</span><span class="p">(</span><span class="n">r_stack</span><span class="p">,</span><span class="w"> </span><span class="n">max.level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Formal class 'RasterStack' [package "raster"] with 11 slots
  ..@ filename: chr ""
  ..@ layers  :List of 11
  ..@ title   : chr(0) 
  ..@ extent  :Formal class 'Extent' [package "raster"] with 4 slots
  ..@ rotated : logi FALSE
  ..@ rotation:Formal class '.Rotation' [package "raster"] with 2 slots
  ..@ ncols   : int 298
  ..@ nrows   : int 116
  ..@ crs     :Formal class 'CRS' [package "sp"] with 1 slot
  ..@ history : list()
  ..@ z       : list()
</code></pre></div></div>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">pixels_extracted_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">extract</span><span class="p">(</span><span class="n">r_stack</span><span class="p">,</span><span class="w"> </span><span class="n">class_data_sf</span><span class="p">,</span><span class="w"> </span><span class="n">df</span><span class="o">=</span><span class="nb">T</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result

Warning in merge.data.frame(as.data.frame(x), as.data.frame(y), ...):
column name 'x' is duplicated in the result
</code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="nf">dim</span><span class="p">(</span><span class="n">pixels_extracted_df</span><span class="p">)</span><span class="w"> 
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 1547   12
</code></pre></div></div>

<p>We have 1547 pixels extracted.</p>

<p>Sometimes useful to store data as a csv: have to remove geometry column.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">class_data_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">class_data_sf</span><span class="w">
</span><span class="n">st_geometry</span><span class="p">(</span><span class="n">class_data_df</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NULL</span><span class="w"> </span><span class="c1"># This will coerce the sf object into a data.frame by removing the geometry</span><span class="w">
</span></code></pre></div></div>

<p>Make the dataframe used for classification.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">pixels_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">pixels_extracted_df</span><span class="p">,</span><span class="w"> </span><span class="n">class_data_df</span><span class="p">,</span><span class="w"> </span><span class="n">by.x</span><span class="o">=</span><span class="s2">"ID"</span><span class="p">,</span><span class="w"> </span><span class="n">by.y</span><span class="o">=</span><span class="s2">"poly_ID"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">head</span><span class="p">(</span><span class="n">pixels_df</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ID       x        y        Red       NIR       Blue      Green     SWIR1
1  1 1615340 936279.2 0.05304649 0.3035397 0.02652384 0.05662384 0.3101271
2  1 1614413 935352.5 0.05782417 0.3295924 0.02751791 0.06305390 0.3453724
3  1 1615340 935352.5 0.05735013 0.3037102 0.02596963 0.05654212 0.3176476
4  1 1616266 935352.5 0.05805403 0.3081988 0.02711912 0.05750944 0.3229090
5  1 1617193 935352.5 0.04147716 0.3058677 0.01839499 0.05076184 0.3003513
6  1 1618120 935352.5 0.04209801 0.3089238 0.01832494 0.05200353 0.2943777
      SWIR2      SWIR3      NDVI      MNDWI record_ID class_ID
1 0.1936452 0.07864757 0.7024759 -0.5474963         1        1
2 0.2102322 0.08679578 0.7014884 -0.5385503         1        1
3 0.2073480 0.08732812 0.6823238 -0.5714722         1        1
4 0.2079238 0.08741243 0.6829839 -0.5666749         1        1
5 0.1692552 0.06590501 0.7611759 -0.5385644         1        1
6 0.1697936 0.06790353 0.7601402 -0.5310712         1        1
</code></pre></div></div>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">table</span><span class="p">(</span><span class="n">pixels_df</span><span class="o">$</span><span class="n">class_ID</span><span class="p">)</span><span class="w"> </span><span class="c1"># count by class of pixels ground truth data</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  1   2   3 
508 285 754 
</code></pre></div></div>

<h3 id="examining-data-used-for-the-classification">Examining data used for the classification</h3>

<p>Define geographic range.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">x_range</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">range</span><span class="p">(</span><span class="n">pixels_df</span><span class="o">$</span><span class="n">Green</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="o">=</span><span class="nb">T</span><span class="p">)</span><span class="w">
</span><span class="n">y_range</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">range</span><span class="p">(</span><span class="n">pixels_df</span><span class="o">$</span><span class="n">NIR</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="o">=</span><span class="nb">T</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Let’s use a palette that reflects flooding or level of water.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">col_palette</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"green"</span><span class="p">,</span><span class="w"> </span><span class="s2">"lightblue"</span><span class="p">,</span><span class="w"> </span><span class="s2">"darkblue"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Many ways of looking at these data:</p>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">plot</span><span class="p">(</span><span class="n">NIR</span><span class="o">~</span><span class="n">Green</span><span class="p">,</span><span class="w"> </span><span class="n">xlim</span><span class="o">=</span><span class="n">x_range</span><span class="p">,</span><span class="w"> </span><span class="n">ylim</span><span class="o">=</span><span class="n">y_range</span><span class="p">,</span><span class="w"> </span><span class="n">cex</span><span class="o">=</span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="n">col_palette</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">pixels_df</span><span class="p">,</span><span class="w"> </span><span class="n">class_ID</span><span class="o">==</span><span class="m">1</span><span class="p">))</span><span class="w">
</span><span class="o">&gt;</span><span class="w"> </span><span class="n">points</span><span class="p">(</span><span class="n">NIR</span><span class="o">~</span><span class="n">Green</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="n">col_palette</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">cex</span><span class="o">=</span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">pixels_df</span><span class="p">,</span><span class="w"> </span><span class="n">class_ID</span><span class="o">==</span><span class="m">2</span><span class="p">))</span><span class="w">
</span><span class="o">&gt;</span><span class="w"> </span><span class="n">points</span><span class="p">(</span><span class="n">NIR</span><span class="o">~</span><span class="n">Green</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="n">col_palette</span><span class="p">[</span><span class="m">3</span><span class="p">],</span><span class="w"> </span><span class="n">cex</span><span class="o">=</span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">pixels_df</span><span class="p">,</span><span class="w"> </span><span class="n">class_ID</span><span class="o">==</span><span class="m">3</span><span class="p">))</span><span class="w">
</span><span class="o">&gt;</span><span class="w"> </span><span class="n">names_vals</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"vegetation"</span><span class="p">,</span><span class="s2">"wetland"</span><span class="p">,</span><span class="s2">"water"</span><span class="p">)</span><span class="w">
</span><span class="o">&gt;</span><span class="w"> </span><span class="n">legend</span><span class="p">(</span><span class="s2">"topleft"</span><span class="p">,</span><span class="w"> </span><span class="n">legend</span><span class="o">=</span><span class="n">names_vals</span><span class="p">,</span><span class="w">
</span><span class="o">+</span><span class="w">        </span><span class="n">pt.cex</span><span class="o">=</span><span class="m">0.7</span><span class="p">,</span><span class="w"> </span><span class="n">cex</span><span class="o">=</span><span class="m">0.7</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="n">col_palette</span><span class="p">,</span><span class="w">
</span><span class="o">+</span><span class="w">        </span><span class="n">pch</span><span class="o">=</span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="c1"># add circle symbol to line</span><span class="w">
</span><span class="o">+</span><span class="w">        </span><span class="n">bty</span><span class="o">=</span><span class="s2">"n"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p class="captioned"><img src="https://cdn.jsdelivr.net/gh/sesync-ci/remote-sensing-classification-lesson@v0.1/docs/images/raster_classification/unnamed-chunk-34-1.png" alt=" " /></p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">NDVI</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">MNDWI</span><span class="p">,</span><span class="w"> </span><span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">-1</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">ylim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">-1</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">cex</span><span class="o">=</span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="n">col_palette</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">pixels_df</span><span class="p">,</span><span class="w"> </span><span class="n">class_ID</span><span class="o">==</span><span class="m">1</span><span class="p">))</span><span class="w">
</span><span class="n">points</span><span class="p">(</span><span class="n">NDVI</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">MNDWI</span><span class="p">,</span><span class="w"> </span><span class="n">cex</span><span class="o">=</span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="n">col_palette</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">pixels_df</span><span class="p">,</span><span class="w"> </span><span class="n">class_ID</span><span class="o">==</span><span class="m">2</span><span class="p">))</span><span class="w">
</span><span class="n">points</span><span class="p">(</span><span class="n">NDVI</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">MNDWI</span><span class="p">,</span><span class="w"> </span><span class="n">cex</span><span class="o">=</span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="n">col_palette</span><span class="p">[</span><span class="m">3</span><span class="p">],</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">pixels_df</span><span class="p">,</span><span class="w"> </span><span class="n">class_ID</span><span class="o">==</span><span class="m">3</span><span class="p">))</span><span class="w">
</span><span class="n">names_vals</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"vegetation"</span><span class="p">,</span><span class="s2">"wetland"</span><span class="p">,</span><span class="s2">"water"</span><span class="p">)</span><span class="w">
</span><span class="n">legend</span><span class="p">(</span><span class="s2">"topright"</span><span class="p">,</span><span class="w"> </span><span class="n">legend</span><span class="o">=</span><span class="n">names_vals</span><span class="p">,</span><span class="w">
       </span><span class="n">pt.cex</span><span class="o">=</span><span class="m">0.7</span><span class="p">,</span><span class="n">cex</span><span class="o">=</span><span class="m">0.7</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="n">col_palette</span><span class="p">,</span><span class="w">
       </span><span class="n">pch</span><span class="o">=</span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="c1"># add circle symbol to line</span><span class="w">
       </span><span class="n">bty</span><span class="o">=</span><span class="s2">"n"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p class="captioned"><img src="https://cdn.jsdelivr.net/gh/sesync-ci/remote-sensing-classification-lesson@v0.1/docs/images/raster_classification/unnamed-chunk-35-1.png" alt=" " /></p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">rasterVis</span><span class="o">::</span><span class="n">histogram</span><span class="p">(</span><span class="n">r_after</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p class="captioned"><img src="https://cdn.jsdelivr.net/gh/sesync-ci/remote-sensing-classification-lesson@v0.1/docs/images/raster_classification/unnamed-chunk-36-1.png" alt=" " /></p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">pixels_df</span><span class="o">$</span><span class="n">class_ID</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">pixels_df</span><span class="o">$</span><span class="n">class_ID</span><span class="p">,</span><span class="w"> </span><span class="n">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">),</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">names_vals</span><span class="p">)</span><span class="w">

</span><span class="n">boxplot</span><span class="p">(</span><span class="n">MNDWI</span><span class="o">~</span><span class="n">class_ID</span><span class="p">,</span><span class="w"> </span><span class="n">pixels_df</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="o">=</span><span class="s2">"category"</span><span class="p">,</span><span class="w">
        </span><span class="n">main</span><span class="o">=</span><span class="s2">"Boxplot for MNDWI per class"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p class="captioned"><img src="https://cdn.jsdelivr.net/gh/sesync-ci/remote-sensing-classification-lesson@v0.1/docs/images/raster_classification/unnamed-chunk-37-1.png" alt=" " /></p>

<h2 id="part-ii-split-data-into-training-and-testing-datasets">Part II: Split data into training and testing datasets</h2>

<p>Let’s keep 30% of data for testing for each class, and set a fixed seed for reproducibility.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">set.seed</span><span class="p">(</span><span class="m">100</span><span class="p">)</span><span class="w">
</span><span class="n">prop</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.3</span><span class="w">
</span><span class="n">table</span><span class="p">(</span><span class="n">pixels_df</span><span class="o">$</span><span class="n">class_ID</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
vegetation    wetland      water 
       508        285        754 
</code></pre></div></div>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">list_data_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vector</span><span class="p">(</span><span class="s2">"list"</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="o">=</span><span class="m">3</span><span class="p">)</span><span class="w">
</span><span class="n">level_labels</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">names_vals</span><span class="w">

</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">){</span><span class="w">
  </span><span class="n">data_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">pixels_df</span><span class="p">,</span><span class="w"> </span><span class="n">class_ID</span><span class="o">==</span><span class="n">level_labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
  </span><span class="n">data_df</span><span class="o">$</span><span class="n">pix_id</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">data_df</span><span class="p">)</span><span class="w">
  </span><span class="n">indices</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.vector</span><span class="p">(</span><span class="n">createDataPartition</span><span class="p">(</span><span class="n">data_df</span><span class="o">$</span><span class="n">pix_id</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">prop</span><span class="p">),</span><span class="w"> </span><span class="n">list</span><span class="o">=</span><span class="nb">F</span><span class="p">))</span><span class="w">
  </span><span class="n">data_df</span><span class="o">$</span><span class="n">training</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">data_df</span><span class="o">$</span><span class="n">pix_id</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">indices</span><span class="p">)</span><span class="w">
  </span><span class="n">list_data_df</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_df</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">data_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">do.call</span><span class="p">(</span><span class="n">rbind</span><span class="p">,</span><span class="w"> </span><span class="n">list_data_df</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="nf">dim</span><span class="p">(</span><span class="n">data_df</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 1547   16
</code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">head</span><span class="p">(</span><span class="n">data_df</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ID       x        y        Red       NIR       Blue      Green     SWIR1
1  1 1615340 936279.2 0.05304649 0.3035397 0.02652384 0.05662384 0.3101271
2  1 1614413 935352.5 0.05782417 0.3295924 0.02751791 0.06305390 0.3453724
3  1 1615340 935352.5 0.05735013 0.3037102 0.02596963 0.05654212 0.3176476
4  1 1616266 935352.5 0.05805403 0.3081988 0.02711912 0.05750944 0.3229090
5  1 1617193 935352.5 0.04147716 0.3058677 0.01839499 0.05076184 0.3003513
6  1 1618120 935352.5 0.04209801 0.3089238 0.01832494 0.05200353 0.2943777
      SWIR2      SWIR3      NDVI      MNDWI record_ID   class_ID pix_id
1 0.1936452 0.07864757 0.7024759 -0.5474963         1 vegetation      1
2 0.2102322 0.08679578 0.7014884 -0.5385503         1 vegetation      2
3 0.2073480 0.08732812 0.6823238 -0.5714722         1 vegetation      3
4 0.2079238 0.08741243 0.6829839 -0.5666749         1 vegetation      4
5 0.1692552 0.06590501 0.7611759 -0.5385644         1 vegetation      5
6 0.1697936 0.06790353 0.7601402 -0.5310712         1 vegetation      6
  training
1        0
2        1
3        0
4        0
5        1
6        0
</code></pre></div></div>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">data_training</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">data_df</span><span class="p">,</span><span class="w"> </span><span class="n">training</span><span class="o">==</span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="part-iii-generate-classification-using-classification-tree-cart-and-support-vector-machine-svm">Part III: Generate classification using classification tree (CART) and support vector machine (SVM)</h2>

<h3 id="classification-and-regression-tree-model-cart">Classification and Regression Tree model (CART)</h3>

<p>Fit model using training data for CART.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">mod_rpart</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rpart</span><span class="p">(</span><span class="n">class_ID</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">NIR</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SWIR1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SWIR2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SWIR3</span><span class="p">,</span><span class="w">
                   </span><span class="n">method</span><span class="o">=</span><span class="s2">"class"</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">data_training</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Plot the fitted classification tree.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">mod_rpart</span><span class="p">,</span><span class="w"> </span><span class="n">uniform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Classification Tree"</span><span class="p">,</span><span class="w"> </span><span class="n">mar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">))</span><span class="w">
</span><span class="n">text</span><span class="p">(</span><span class="n">mod_rpart</span><span class="p">,</span><span class="w"> </span><span class="n">cex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">.8</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p class="captioned"><img src="https://cdn.jsdelivr.net/gh/sesync-ci/remote-sensing-classification-lesson@v0.1/docs/images/raster_classification/unnamed-chunk-43-1.png" alt=" " /></p>

<p>Now predict the subset data based on the model.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">raster_out_filename_rp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">file.path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"r_predicted_rpart_"</span><span class="p">,</span><span class="w"> </span><span class="n">out_suffix</span><span class="p">,</span><span class="w"> </span><span class="n">file_format</span><span class="p">))</span><span class="w">

</span><span class="n">r_predicted_rpart</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">r_stack</span><span class="p">,</span><span class="w"> </span><span class="n">mod_rpart</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s1">'class'</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">raster_out_filename_rp</span><span class="p">,</span><span class="w">
                             </span><span class="n">progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'text'</span><span class="p">,</span><span class="w"> </span><span class="n">overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">plot</span><span class="p">(</span><span class="n">r_predicted_rpart</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p class="captioned"><img src="https://cdn.jsdelivr.net/gh/sesync-ci/remote-sensing-classification-lesson@v0.1/docs/images/raster_classification/unnamed-chunk-45-1.png" alt=" " /></p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">r_predicted_rpart</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ratify</span><span class="p">(</span><span class="n">r_predicted_rpart</span><span class="p">)</span><span class="w"> </span><span class="c1"># creates a raster attribute table (rat)</span><span class="w">
</span><span class="n">rat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">levels</span><span class="p">(</span><span class="n">r_predicted_rpart</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span><span class="w">
</span><span class="n">rat</span><span class="o">$</span><span class="n">legend</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"vegetation"</span><span class="p">,</span><span class="w"> </span><span class="s2">"wetland"</span><span class="p">,</span><span class="w"> </span><span class="s2">"water"</span><span class="p">)</span><span class="w">
</span><span class="n">levels</span><span class="p">(</span><span class="n">r_predicted_rpart</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rat</span><span class="w">

</span><span class="n">levelplot</span><span class="p">(</span><span class="n">r_predicted_rpart</span><span class="p">,</span><span class="w"> </span><span class="n">maxpixels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1e6</span><span class="p">,</span><span class="w">
          </span><span class="n">col.regions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"green"</span><span class="p">,</span><span class="s2">"blue"</span><span class="p">,</span><span class="s2">"darkblue"</span><span class="p">),</span><span class="w">
          </span><span class="n">scales</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">draw</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">),</span><span class="w">
          </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Classification Tree"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p class="captioned"><img src="https://cdn.jsdelivr.net/gh/sesync-ci/remote-sensing-classification-lesson@v0.1/docs/images/raster_classification/unnamed-chunk-46-1.png" alt=" " /></p>

<h3 id="support-vector-machine-classification-svm">Support Vector Machine classification (SVM)</h3>

<p>Set class_ID as factor to generate classification.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">mod_svm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">svm</span><span class="p">(</span><span class="n">class_ID</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">Red</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">NIR</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Blue</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Green</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SWIR1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SWIR2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SWIR3</span><span class="p">,</span><span class="w">
               </span><span class="n">data</span><span class="o">=</span><span class="n">data_training</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="o">=</span><span class="s2">"C-classification"</span><span class="p">,</span><span class="w">
               </span><span class="n">kernel</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">)</span><span class="w"> </span><span class="c1"># can be radial</span><span class="w">
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">summary</span><span class="p">(</span><span class="n">mod_svm</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Call:
svm(formula = class_ID ~ Red + NIR + Blue + Green + SWIR1 + SWIR2 + 
    SWIR3, data = data_training, method = "C-classification", 
    kernel = "linear")


Parameters:
   SVM-Type:  C-classification 
 SVM-Kernel:  linear 
       cost:  1 
      gamma:  0.1428571 

Number of Support Vectors:  110

 ( 12 54 44 )


Number of Classes:  3 

Levels: 
 vegetation wetland water
</code></pre></div></div>

<p>Now predict the subset data based on the model.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">raster_out_filename_sv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">file.path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"r_predicted_svm_"</span><span class="p">,</span><span class="w"> </span><span class="n">out_suffix</span><span class="p">,</span><span class="w"> </span><span class="n">file_format</span><span class="p">))</span><span class="w">
  
</span><span class="n">r_predicted_svm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">r_stack</span><span class="p">,</span><span class="w"> </span><span class="n">mod_svm</span><span class="p">,</span><span class="w"> </span><span class="n">progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'text'</span><span class="p">,</span><span class="w">
                           </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">raster_out_filename_sv</span><span class="p">,</span><span class="w"> </span><span class="n">overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">r_predicted_svm</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p class="captioned"><img src="https://cdn.jsdelivr.net/gh/sesync-ci/remote-sensing-classification-lesson@v0.1/docs/images/raster_classification/unnamed-chunk-50-1.png" alt=" " /></p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">rasterVis</span><span class="o">::</span><span class="n">histogram</span><span class="p">(</span><span class="n">r_predicted_svm</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p class="captioned"><img src="https://cdn.jsdelivr.net/gh/sesync-ci/remote-sensing-classification-lesson@v0.1/docs/images/raster_classification/unnamed-chunk-51-1.png" alt=" " /></p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">r_predicted_svm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ratify</span><span class="p">(</span><span class="n">r_predicted_svm</span><span class="p">)</span><span class="w">
</span><span class="n">rat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">levels</span><span class="p">(</span><span class="n">r_predicted_svm</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span><span class="w">
</span><span class="n">rat</span><span class="o">$</span><span class="n">legend</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"vegetation"</span><span class="p">,</span><span class="w"> </span><span class="s2">"wetland"</span><span class="p">,</span><span class="w"> </span><span class="s2">"water"</span><span class="p">)</span><span class="w">
</span><span class="n">levels</span><span class="p">(</span><span class="n">r_predicted_svm</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rat</span><span class="w">

</span><span class="n">levelplot</span><span class="p">(</span><span class="n">r_predicted_svm</span><span class="p">,</span><span class="w"> </span><span class="n">maxpixels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1e6</span><span class="p">,</span><span class="w">
          </span><span class="n">col.regions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"green"</span><span class="p">,</span><span class="s2">"blue"</span><span class="p">,</span><span class="s2">"darkblue"</span><span class="p">),</span><span class="w">
          </span><span class="n">scales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">draw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">),</span><span class="w">
          </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"SVM classification"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p class="captioned"><img src="https://cdn.jsdelivr.net/gh/sesync-ci/remote-sensing-classification-lesson@v0.1/docs/images/raster_classification/unnamed-chunk-52-1.png" alt=" " /></p>

<h2 id="part-iv-assessment-and-comparison-of-model-performance">Part IV: Assessment and comparison of model performance</h2>

<p>Set up testing data:
Full dataset, let’s use data points for testing.</p>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="nf">dim</span><span class="p">(</span><span class="n">data_df</span><span class="p">)</span><span class="w"> 
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 1547   16
</code></pre></div></div>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="c1"># omit values that contain NA, because may be problematic with SVM.</span><span class="w">
</span><span class="n">data_testing</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">na.omit</span><span class="p">(</span><span class="n">subset</span><span class="p">(</span><span class="n">data_df</span><span class="p">,</span><span class="w"> </span><span class="n">training</span><span class="o">==</span><span class="m">0</span><span class="p">))</span><span class="w"> 
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="nf">dim</span><span class="p">(</span><span class="n">data_testing</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 450  16
</code></pre></div></div>

<p>Predict on testing data using rpart model fitted with testing data.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">testing_rpart</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">mod_rpart</span><span class="p">,</span><span class="w"> </span><span class="n">data_testing</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s1">'class'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Predict on testing data using SVM model fitted with testing data.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">testing_svm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">mod_svm</span><span class="p">,</span><span class="w"> </span><span class="n">data_testing</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s1">'class'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Predicted number of pixels in each class:</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">table</span><span class="p">(</span><span class="n">testing_rpart</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>testing_rpart
vegetation    wetland      water 
       149         77        224 
</code></pre></div></div>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">table</span><span class="p">(</span><span class="n">testing_svm</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>testing_svm
vegetation    wetland      water 
       150         78        222 
</code></pre></div></div>

<h3 id="generate-confusion-matrix-to-assess-the-accuracy-of-the-image-classification">Generate confusion matrix to assess the accuracy of the image classification</h3>

<p>More info on confusion matrices here: http://spatial-analyst.net/ILWIS/htm/ilwismen/confusion_matrix.htm</p>

<p>Groundtruth data:</p>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">table</span><span class="p">(</span><span class="n">data_testing</span><span class="o">$</span><span class="n">class_ID</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
vegetation    wetland      water 
       149         84        217 
</code></pre></div></div>

<p>Classification model results:</p>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">table</span><span class="p">(</span><span class="n">testing_rpart</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>testing_rpart
vegetation    wetland      water 
       149         77        224 
</code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">table</span><span class="p">(</span><span class="n">testing_svm</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>testing_svm
vegetation    wetland      water 
       150         78        222 
</code></pre></div></div>

<p>To generate confusion matrix, need to use: 
testing_rpart: contains classification model prediction in the rows
data_testing$class_ID: this column contains groundtruth data</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">tb_rpart</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">table</span><span class="p">(</span><span class="n">testing_rpart</span><span class="p">,</span><span class="w"> </span><span class="n">data_testing</span><span class="o">$</span><span class="n">class_ID</span><span class="p">)</span><span class="w">
</span><span class="n">tb_svm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">table</span><span class="p">(</span><span class="n">testing_svm</span><span class="p">,</span><span class="w"> </span><span class="n">data_testing</span><span class="o">$</span><span class="n">class_ID</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Matrices identifying correct and incorrect classifications by models:</p>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">tb_rpart</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>             
testing_rpart vegetation wetland water
   vegetation        146       3     0
   wetland             3      68     6
   water               0      13   211
</code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">tb_svm</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            
testing_svm  vegetation wetland water
  vegetation        149       1     0
  wetland             0      73     5
  water               0      10   212
</code></pre></div></div>

<p>Accuracy (producer’s accuracy): the fraction of correctly classified pixels compared to all pixels of that groundtruth class.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">tb_rpart</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">tb_rpart</span><span class="p">[,</span><span class="m">1</span><span class="p">])</span><span class="w"> </span><span class="c1"># producer accuracy</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 0.9798658
</code></pre></div></div>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">tb_svm</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">tb_svm</span><span class="p">[,</span><span class="m">1</span><span class="p">])</span><span class="w"> </span><span class="c1"># producer accuracy</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 1
</code></pre></div></div>

<p>Looking at accuracy more closely:</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="c1"># overall accuracy for rpart</span><span class="w">
</span><span class="nf">sum</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">tb_rpart</span><span class="p">))</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">table</span><span class="p">(</span><span class="n">testing_rpart</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 0.9444444
</code></pre></div></div>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="c1"># overall accuracy for svm</span><span class="w">
</span><span class="nf">sum</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">tb_svm</span><span class="p">))</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">table</span><span class="p">(</span><span class="n">testing_svm</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 0.9644444
</code></pre></div></div>

<p>Generate more accurate measurements from functions in the caret package:</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">accuracy_info_rpart</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">confusionMatrix</span><span class="p">(</span><span class="n">testing_rpart</span><span class="p">,</span><span class="w"> </span><span class="n">data_testing</span><span class="o">$</span><span class="n">class_ID</span><span class="p">,</span><span class="w"> </span><span class="n">positive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">)</span><span class="w">
</span><span class="n">accuracy_info_svm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">confusionMatrix</span><span class="p">(</span><span class="n">testing_svm</span><span class="p">,</span><span class="w"> </span><span class="n">data_testing</span><span class="o">$</span><span class="n">class_ID</span><span class="p">,</span><span class="w"> </span><span class="n">positive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Overall accuracy produced:</p>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">accuracy_info_rpart</span><span class="o">$</span><span class="n">overall</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      Accuracy          Kappa  AccuracyLower  AccuracyUpper   AccuracyNull 
  9.444444e-01   9.101603e-01   9.190787e-01   9.637284e-01   4.822222e-01 
AccuracyPValue  McnemarPValue 
 1.266887e-101            NaN 
</code></pre></div></div>

<div class="language-r input highlighter-rouge" title="Console"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">accuracy_info_svm</span><span class="o">$</span><span class="n">overall</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      Accuracy          Kappa  AccuracyLower  AccuracyUpper   AccuracyNull 
  9.644444e-01   9.425947e-01   9.429011e-01   9.795429e-01   4.822222e-01 
AccuracyPValue  McnemarPValue 
 9.645095e-114            NaN 
</code></pre></div></div>

<p>Write out the results:</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-5.R"><div class="highlight"><pre class="highlight"><code><span class="n">table_out_filename</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">file.path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"confusion_matrix_rpart.txt"</span><span class="p">)</span><span class="w">
</span><span class="n">write.table</span><span class="p">(</span><span class="n">accuracy_info_rpart</span><span class="o">$</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">table_out_filename</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="o">=</span><span class="s2">","</span><span class="p">)</span><span class="w">

</span><span class="n">table_out_filename</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">file.path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"confusion_matrix_svm.txt"</span><span class="p">)</span><span class="w">
</span><span class="n">write.table</span><span class="p">(</span><span class="n">accuracy_info_svm</span><span class="o">$</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">table_out_filename</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="o">=</span><span class="s2">","</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p class="ToS"><a href="#/slides/raster_classification">Top of Section</a></p>



        <hr>

<p>If you need to catch-up before a section of code will work, just squish it's
🍅 to copy code above it into your clipboard. Then paste into your interpreter's
console, run, and you'll be ready to start in on that section. Code copied by
both 🍅 and 📋 will also appear below, where you can edit first, and then copy,
paste, and run again.</p>

<div class="output">
  <pre id="ketchup" contenteditable="true"><code># Nothing here yet!</code></pre>
</div>

<script>
$(document).ready(function(){
  
  // Add code help icons to code blocks
  $('.input, .text-document').append('<ul class="code-help">');
  $('.code-help')
    .append('<li class="clipboard">📋</li>');
  $('.text-document:not(.no-eval) .code-help')
    .append('<li class="ketchup">🍅</li>');

  // Bind copy actions to mouse clicks on icons
  var $ketchup = $('#ketchup');
  var rng = document.createRange();
  var sel = window.getSelection();
  $('.ketchup').click(function(){
    var $prev = $(this)
      .parents('.text-document')
      .prevAll('.text-document:has(.ketchup)');
    $ketchup.find('code').text($prev.find('pre').text());
    rng.selectNodeContents($ketchup[0]);
    sel.removeAllRanges();
    sel.addRange(rng);
    document.execCommand("copy");
    sel.removeAllRanges();
  });
  $('.text-document .clipboard').click(function(){
    var pre = $(this).parents('.text-document').find('pre').text();
    $ketchup.find('code').text(pre);
    rng.selectNodeContents($ketchup[0]);
    sel.removeAllRanges();
    sel.addRange(rng);
    document.execCommand("copy");
    sel.removeAllRanges();
  });
  $('.input .clipboard').click(function(){
    var pre = $(this).parents('.input').find('pre').text();
    pre = pre.replace(/(^|\n)> */g, '$1');
    $ketchup.find('code').text(pre);
    rng.selectNodeContents($ketchup[0]);
    sel.removeAllRanges();
    sel.addRange(rng);
    document.execCommand("copy");
    sel.removeAllRanges();
  });
});
</script>
      </div>
    </div>
    <script>
$(document).ready(function(){
  // Add links to R and Python package repositories
  $('a.rlib').map(function(){
    this.href = 'https://cran.r-project.org/package=' + this.innerText;
  });
  $('a.pylib').map(function(){
    this.href = 'https://pypi.python.org/pypi/' + this.innerText;
  });
});
</script>

  </body>
</html>
